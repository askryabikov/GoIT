import random
from collections import Counter
import matplotlib.pyplot as plt


def theoretical_probs():
    """
    Теоретичні ймовірності сум 2..12 для двох кубиків

    Логіка:
    - Усього можливих результатів: 6 * 6 = 36 (усі пари (d1, d2)).
    - Кількість способів отримати суму:
        2  -> 1  спосіб:  (1,1)
        3  -> 2  способи: (1,2), (2,1)
        ...
        7  -> 6  способів: (1,6)...(6,1)
        ...
        12 -> 1  спосіб:  (6,6)
    - Ймовірність = (кількість способів) / 36
    """
    counts = {
        2: 1, 3: 2, 4: 3, 5: 4, 6: 5, 7: 6,
        8: 5, 9: 4, 10: 3, 11: 2, 12: 1
    }
    # Перетворюємо "кількість способів" у ймовірності
    return {s: c / 36 for s, c in counts.items()}


def monte_carlo_dice(num_rolls=100_000, seed=42):
    """
    Метод Монте-Карло: імітуємо багато кидків двох кубиків і оцінюємо ймовірності сум.

    Параметри:
    - num_rolls: скільки разів кидаємо два кубики
    - seed: "зерно" генератора випадкових чисел для відтворюваного результату

    Повертає:
    - counter: скільки разів випала кожна сума
    - probs: оцінені ймовірності сум 2..12
    """
    # Фіксуємо випадковість, щоб результат можна було повторити
    random.seed(seed)

    # Counter зручно рахує частоти (скільки разів зустрілась кожна сума)
    counter = Counter()

    # Основний цикл симуляції
    for _ in range(num_rolls):
        # Випадкове число від 1 до 6 — це результат одного кубика
        d1 = random.randint(1, 6)
        d2 = random.randint(1, 6)
        s = d1 + d2                    # сума двох кубиків
        counter[s] += 1                # збільшуємо лічильник для цієї суми

    # Перетворюємо частоти у ймовірності: P(sum=s) ≈ count(s) / num_rolls
    # Якщо раптом якась сума не зустрілась (дуже малоймовірно при 100k),
    # тоді беремо 0.
    probs = {s: counter.get(s, 0) / num_rolls for s in range(2, 13)}

    return counter, probs


def print_comparison_table(counter, mc_probs, th_probs, num_rolls):
    """
    Друк таблиці для порівняння:
    - скільки разів випала сума (Count)
    - оцінена ймовірність Монте-Карло (MC prob)
    - теоретична ймовірність (Theory prob)
    - абсолютна різниця |MC - Theory| (Abs diff)
    """
    print(f"Кількість кидків: {num_rolls}\n")

    # Заголовок таблиці (вирівнювання по ширині для красивого виводу)
    print("{:<5} {:>10} {:>14} {:>14} {:>14}".format(
        "Сума", "К-сть", "MC ймов.", "Теор. ймов.", "|Різниця|"
    ))
    print("-" * 70)

    # Виводимо рядок для кожної суми 2..12
    for s in range(2, 13):
        count = counter.get(s, 0)      # скільки разів випала сума s
        mc = mc_probs[s]               # оцінка Монте-Карло
        th = th_probs[s]               # теоретичне значення
        diff = abs(mc - th)            # абсолютне відхилення
        print("{:<5} {:>10} {:>14.6f} {:>14.6f} {:>14.6f}".format(
            s, count, mc, th, diff
        ))


def plot_probs(mc_probs, th_probs):
    """
    Побудова графіка:
    - стовпчики: ймовірності, отримані методом Монте-Карло
    - лінія з точками: теоретичні ймовірності

    Це наочно показує, наскільки симуляція наближається до теорії.
    """
    sums = list(range(2, 13))                 # суми 2..12 по осі X
    mc = [mc_probs[s] for s in sums]          # Монте-Карло ймовірності
    th = [th_probs[s] for s in sums]          # теоретичні ймовірності

    plt.figure(figsize=(10, 5))

    # Стовпчики Монте-Карло
    plt.bar(sums, mc, width=0.7, label="Монте-Карло (симуляція)")

    # Лінія теорії
    plt.plot(sums, th, marker="o", linewidth=2, label="Теоретичні значення")

    # Підписи, сітка, легенда
    plt.title("Ймовірності сум двох кубиків: Монте-Карло vs Теорія")
    plt.xlabel("Сума (2..12)")
    plt.ylabel("Ймовірність")
    plt.xticks(sums)
    plt.grid(True, alpha=0.3)
    plt.legend()

    plt.show()


if __name__ == "__main__":
    # Налаштування експерименту
    num_rolls = 100_000   # кількість кидків
    seed = 42             # фіксація випадковості (щоб результат повторювався)

    # 1. Теоретичні ймовірності
    th_probs = theoretical_probs()

    # 2. Монте-Карло симуляція (частоти + оцінені ймовірності)
    counter, mc_probs = monte_carlo_dice(num_rolls=num_rolls, seed=seed)

    # 3. Порівняльна таблиця
    print_comparison_table(counter, mc_probs, th_probs, num_rolls)

    # 4. Графік для візуального порівняння
    plot_probs(mc_probs, th_probs)
